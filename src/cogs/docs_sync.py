"""Docs Sync Cog â€” GitHub â†’ Discord webhook trigger â†’ Claude Code ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã€‚

2ã¤ã®ãƒ¢ãƒ¼ãƒ‰:
- "ğŸ”„ docs-sync" (é€šå¸¸push): è‹±èªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®åŒæœŸã®ã¿ï¼ˆè»½é‡ãƒ»é«˜é€Ÿï¼‰
- "ğŸ”„ docs-sync-translate" (ãƒªãƒªãƒ¼ã‚¹æ™‚): å…¨è¨€èªç¿»è¨³ï¼ˆja, zh-CN, ko, es, pt-BR, frï¼‰

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ:
- Discord webhook ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆwebhook_id ã‚ã‚Šï¼‰ã®ã¿å—ã‘ä»˜ã‘ã‚‹
- å›ºå®šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ "ğŸ”„ docs-sync" ã®ã¿åå¿œï¼ˆãã‚Œä»¥å¤–ã¯ç„¡è¦–ï¼‰
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã‚µãƒ¼ãƒãƒ¼å´ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼ˆwebhookçµŒç”±ã§æ³¨å…¥ä¸å¯ï¼‰
- webhook URLãŒæ¼æ´©ã—ã¦ã‚‚ã€åŒæœŸãŒç„¡é§„ã«èµ°ã‚‹ã ã‘ï¼ˆä»»æ„ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œä¸å¯ï¼‰
"""

from __future__ import annotations

import asyncio
import logging

import discord
from discord.ext import commands

from claude_discord.claude.runner import ClaudeRunner
from claude_discord.discord_ui.chunker import chunk_message
from claude_discord.discord_ui.embeds import error_embed

logger = logging.getLogger(__name__)

TRIGGER_SYNC = "ğŸ”„ docs-sync"
TRIGGER_TRANSLATE = "ğŸ”„ docs-sync-translate"

_COMMON_HEADER = """\
You are a documentation maintainer for the claude-code-discord-bridge project.
The repository is at /home/ebi/claude-code-discord-bridge.

## Step 1: Pull latest changes

```bash
cd /home/ebi/claude-code-discord-bridge && git pull origin main
```

## Step 2: Analyze what changed

Run `git diff HEAD~1 HEAD --stat` and `git diff HEAD~1 HEAD` to understand what changed.

## Step 3: Update English documentation if needed

If **source code** (.py files) changed:
- Read the changed code and check if README.md or CONTRIBUTING.md need updates
- Update sections about features, architecture, configuration, etc. if the code changes affect them
- Keep documentation accurate and in sync with the code
- Do NOT update docs for trivial changes (formatting, comments, internal refactors that don't change behavior)
"""

_TRANSLATE_STEP = """\

## Step 4: Translate to all supported languages

Target languages (create docs/{lang}/ for each):
- `ja` â€” Japanese (æ—¥æœ¬èª)
- `zh-CN` â€” Chinese Simplified (ç®€ä½“ä¸­æ–‡)
- `ko` â€” Korean (í•œêµ­ì–´)
- `es` â€” Spanish (EspaÃ±ol)
- `pt-BR` â€” Portuguese - Brazil (PortuguÃªs)
- `fr` â€” French (FranÃ§ais)

For each English doc (README.md, CONTRIBUTING.md), create or update its translation in every language directory.

Translation rules:
1. Keep all markdown formatting, code blocks, links, and badges intact
2. Do NOT translate: code snippets, URLs, file paths, variable names, "claude-code-discord-bridge", common English tech terms (CLI, API, Cog, thread, session, subprocess, etc.)
3. DO translate: headings, descriptions, explanatory text, table headers/descriptions, comments, notes
4. Add a bilingual notice at the top of each translated file (in English + the target language):
   ```
   > **Note:** This is an auto-translated version of the original English documentation.
   > If there are any discrepancies, the [English version](../../README.md) takes precedence.
   > (åŒã˜å†…å®¹ã‚’ãã®è¨€èªã§)
   ```
5. Use natural, fluent language â€” not mechanical translation. Write as a native speaker would
6. For README.md, update relative links to point to same-language versions where they exist
"""

_TRANSLATE_JA_STEP = """\

## Step 4: Translate to Japanese

Update or create Japanese translations in `docs/ja/` for each English doc (README.md, CONTRIBUTING.md).

Translation rules:
1. Keep all markdown formatting, code blocks, links, and badges intact
2. Do NOT translate: code snippets, URLs, file paths, variable names, "claude-code-discord-bridge", common English tech terms (CLI, API, Cog, thread, session, subprocess, etc.)
3. DO translate: headings, descriptions, explanatory text, table headers/descriptions, comments, notes
4. Add a bilingual notice at the top:
   ```
   > **Note:** This is an auto-translated version of the original English documentation.
   > If there are any discrepancies, the [English version](../../README.md) takes precedence.
   > **æ³¨æ„:** ã“ã‚Œã¯è‹±èªã®ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ç¿»è¨³ã—ãŸã‚‚ã®ã§ã™ã€‚
   > å†…å®¹ã«ç›¸é•ãŒã‚ã‚‹å ´åˆã¯ã€[è‹±èªç‰ˆ](../../README.md)ãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚
   ```
5. Use natural, fluent Japanese â€” not mechanical translation
6. Update relative links to point to Japanese versions where they exist
"""

_PR_STEP_SYNC = """\

## Step 5: Create a PR

If any documentation files were changed:

```bash
cd /home/ebi/claude-code-discord-bridge
git checkout -b docs-sync/$(date +%Y%m%d-%H%M%S)
git add -A
git commit -m "[docs-sync] Update documentation (English + Japanese)

Auto-generated by docs-sync workflow."
git push -u origin HEAD
gh pr create --title "[docs-sync] Update documentation (English + Japanese)" --body "Auto-generated documentation sync.

Changes:
- Updated English docs to reflect code changes (if applicable)
- Synchronized Japanese translation

This PR was automatically created by the docs-sync system."
```

If nothing changed, just report that docs are already up to date.

## Important
- NEVER modify source code (.py files) â€” only documentation (.md files)
- Commit messages MUST start with "[docs-sync]" to prevent infinite loops
- If unsure whether a code change needs doc updates, err on the side of NOT updating
"""

_PR_STEP_TRANSLATE = """\

## Step 5: Create a PR

If any files were changed:

```bash
cd /home/ebi/claude-code-discord-bridge
git checkout -b docs-sync/$(date +%Y%m%d-%H%M%S)
git add -A
git commit -m "[docs-sync] Update documentation and translations

Auto-generated by docs-sync workflow."
git push -u origin HEAD
gh pr create --title "[docs-sync] Update documentation and translations" --body "Auto-generated documentation sync.

Changes:
- Updated English docs to reflect code changes (if applicable)
- Synchronized translations (ja, zh-CN, ko, es, pt-BR, fr)

This PR was automatically created by the docs-sync system."
```

If nothing changed, just report that docs are already up to date.

## Important
- NEVER modify source code (.py files) â€” only documentation (.md files)
- Commit messages MUST start with "[docs-sync]" to prevent infinite loops
- If unsure whether a code change needs doc updates, err on the side of NOT updating
"""

# Assembled prompts
DOCS_SYNC_PROMPT = _COMMON_HEADER + _TRANSLATE_JA_STEP + _PR_STEP_SYNC
DOCS_TRANSLATE_PROMPT = _COMMON_HEADER + _TRANSLATE_STEP + _PR_STEP_TRANSLATE


class DocsSyncCog(commands.Cog):
    """Cog that handles automated documentation sync triggered by Discord webhooks."""

    def __init__(
        self,
        bot: commands.Bot,
        runner: ClaudeRunner,
        channel_id: int,
    ) -> None:
        self.bot = bot
        self.runner = runner
        self.channel_id = channel_id
        self._lock = asyncio.Lock()

    @commands.Cog.listener()
    async def on_message(self, message: discord.Message) -> None:
        """Handle webhook trigger messages."""
        # Only respond to webhook messages (not regular users, not bots)
        if not message.webhook_id:
            return

        # Only in the configured channel
        if message.channel.id != self.channel_id:
            return

        # Determine mode from trigger message
        content = message.content.strip()
        if content == TRIGGER_TRANSLATE:
            prompt = DOCS_TRANSLATE_PROMPT
            mode = "translate"
        elif content.startswith(TRIGGER_SYNC):
            prompt = DOCS_SYNC_PROMPT
            mode = "sync"
        else:
            return

        logger.info(f"docs-sync ãƒˆãƒªã‚¬ãƒ¼å—ä¿¡ (mode={mode}): {content}")

        # Prevent concurrent runs
        if self._lock.locked():
            await message.reply("â³ docs-sync ã¯æ—¢ã«å®Ÿè¡Œä¸­ã§ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
            return

        async with self._lock:
            await self._run_docs_sync(message, prompt, mode)

    async def _run_docs_sync(
        self,
        trigger_message: discord.Message,
        prompt: str,
        mode: str,
    ) -> None:
        """Run the docs sync process via Claude Code."""
        label = "ğŸ“„ docs-sync" if mode == "sync" else "ğŸŒ docs-translate"
        thread = await trigger_message.create_thread(name=label)

        if mode == "sync":
            await thread.send("ğŸ”„ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒæœŸã‚’é–‹å§‹ã—ã¾ã™ï¼ˆè‹±èª + æ—¥æœ¬èªï¼‰...")
        else:
            await thread.send("ğŸŒ å…¨è¨€èªç¿»è¨³ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆæ•°åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰...")

        timeout = 300 if mode == "sync" else 900  # 5min for sync, 15min for translate

        runner = ClaudeRunner(
            command=self.runner.command,
            model=self.runner.model,
            permission_mode="default",  # Full permissions for git operations
            working_dir="/home/ebi/claude-code-discord-bridge",
            timeout_seconds=timeout,
        )

        accumulated_text = ""
        tool_count = 0

        try:
            from claude_discord.claude.types import MessageType

            async for event in runner.run(prompt, session_id=None):
                if event.message_type == MessageType.ASSISTANT:
                    if event.text:
                        accumulated_text = event.text

                # Report tool usage as progress updates
                if event.tool_use:
                    tool_count += 1
                    desc = event.tool_use.display_name
                    if tool_count <= 50:  # Don't spam too much
                        await thread.send(f"âš™ï¸ {desc}")

                if event.is_complete:
                    if event.error:
                        await thread.send(embed=error_embed(event.error))
                        await trigger_message.add_reaction("âŒ")
                    else:
                        response_text = event.text or accumulated_text
                        if response_text:
                            for chunk in chunk_message(response_text):
                                await thread.send(chunk)
                        await trigger_message.add_reaction("âœ…")

        except Exception:
            logger.exception("docs-sync ã‚¨ãƒ©ãƒ¼")
            await thread.send(embed=error_embed("docs-sync ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"))
            await trigger_message.add_reaction("âŒ")
